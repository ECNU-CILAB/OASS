<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>oass.AlgorithmicTrading &mdash; OASS 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> OASS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/UnderstandingOASS.html">Understanding OASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/ShortestPath.html">OASS for Shortest Path</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/AlgorithmicTrading.html">OASS for Algorithmic Trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/OrderExecution.html">OASS for Order Execution</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/oass.StaticDirectedAcyclicGraph.html">oass.StaticDirectedAcyclicGraph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/oass.GradientCalculator.html">oass.GradientCalculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/oass.AlgorithmicTrading.html">oass.AlgorithmicTrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/oass.ShortestPath.html">oass.ShortestPath</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OASS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>oass.AlgorithmicTrading</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for oass.AlgorithmicTrading</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">oass.StaticDirectedAcyclicGraph</span> <span class="kn">import</span> <span class="n">StaticDirectedAcyclicGraph</span>
<span class="kn">from</span> <span class="nn">oass.GradientCalculator</span> <span class="kn">import</span> <span class="n">GradientCalculator</span>
<span class="kn">import</span> <span class="nn">torch</span>


<div class="viewcode-block" id="DecisionMakerOASS"><a class="viewcode-back" href="../../api/oass.AlgorithmicTrading.html#oass.AlgorithmicTrading.DecisionMakerOASS">[docs]</a><span class="k">class</span> <span class="nc">DecisionMakerOASS</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;The decision maker of OASS for algorithmic trading.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        head_mask (int): ``head_mask``.</span>
<span class="sd">        tail_mask (int): ``tail_mask``.</span>
<span class="sd">        device (torch.device): The computing device.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">head_mask</span><span class="p">,</span> <span class="n">tail_mask</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head_mask</span> <span class="o">=</span> <span class="n">head_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tail_mask</span> <span class="o">=</span> <span class="n">tail_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the decisions of a model.</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            model (torch.nn.Module): The neural network model.</span>
<span class="sd">            input_data (torch.tensor): A batch of sequencial environment states. The shape is ``(batch_size, sequence_length, input_size)``.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            signal_series (torch.tensor): A batch of sequencial actions.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">signal_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">output_data_batch</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
            <span class="n">output_data_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output_data_batch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">output_data_batch</span> <span class="o">=</span> <span class="n">output_data_batch</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">output_data_sequence</span> <span class="ow">in</span> <span class="n">output_data_batch</span><span class="p">:</span>
            <span class="n">signal_sequence</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_data_sequence</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_mask</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail_mask</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">signal</span><span class="p">]</span>
                <span class="n">signal_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
            <span class="n">signal_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal_sequence</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">signal_data</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span></div>


<div class="viewcode-block" id="TrainerOASS"><a class="viewcode-back" href="../../api/oass.AlgorithmicTrading.html#oass.AlgorithmicTrading.TrainerOASS">[docs]</a><span class="k">class</span> <span class="nc">TrainerOASS</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;The trainer of OASS for algorithmic trading.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        head_mask (int): ``head_mask``.</span>
<span class="sd">        tail_mask (int): ``tail_mask``.</span>
<span class="sd">        sequence_length (int): The length of each sequence.</span>
<span class="sd">        buy_cost_pct (float): The cost ratio when the agent chooses to buy.</span>
<span class="sd">        sell_cost_pct (float): The cost ratio when the agent chooses to sell.</span>
<span class="sd">        gamma (float): The discount factor in the reward value function.</span>
<span class="sd">        device (torch.device): The computing device.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        difficulty (float): ``difficulty``.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">head_mask</span><span class="p">,</span>
        <span class="n">tail_mask</span><span class="p">,</span>
        <span class="n">sequence_length</span><span class="p">,</span>
        <span class="n">buy_cost_pct</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">sell_cost_pct</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head_mask</span> <span class="o">=</span> <span class="n">head_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tail_mask</span> <span class="o">=</span> <span class="n">tail_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="n">sequence_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buy_cost_pct</span> <span class="o">=</span> <span class="n">buy_cost_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sell_cost_pct</span> <span class="o">=</span> <span class="n">sell_cost_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradient_calculator</span> <span class="o">=</span> <span class="n">GradientCalculator</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">difficulty</span> <span class="o">=</span> <span class="mf">0.0</span>

<div class="viewcode-block" id="TrainerOASS.build_graph"><a class="viewcode-back" href="../../api/oass.AlgorithmicTrading.html#oass.AlgorithmicTrading.TrainerOASS.build_graph">[docs]</a>    <span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a DAG.</span>
<span class="sd">        </span>
<span class="sd">        Assuming that the ``sequence_length`` is :math:`n`, then there are :math:`3n` nodes in the graph. A node is represented as :math:`(i, j)`, where :math:`i\in\{0,1,\dots,n-1\}` represents the time step and :math:`j\in\{-1,0,1\}` represents the number of stocks held.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">StaticDirectedAcyclicGraph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">si</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">si_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">si</span><span class="p">),</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">si_</span><span class="p">))</span></div>

<div class="viewcode-block" id="TrainerOASS.calculate_reward"><a class="viewcode-back" href="../../api/oass.AlgorithmicTrading.html#oass.AlgorithmicTrading.TrainerOASS.calculate_reward">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buy_price_batch</span><span class="p">,</span> <span class="n">sell_price_batch</span><span class="p">,</span> <span class="n">buy_cost_pct</span><span class="p">,</span> <span class="n">sell_cost_pct</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the node rewards and edge rewards.</span>
<span class="sd">        </span>
<span class="sd">        In this problem, these rewards are dynamic. The node reward represents the corresponding stock value at the last time step, and is zero at other time steps. The edge rewards represent the change of money. For example, the edge reward of :math:`\langle(i,0), (i+1,1)\rangle` is :math:`-p(1+\alpha)`, where :math:`p` is the price and :math:`\alpha` is the transaction cost ratio.</span>

<span class="sd">        Args:</span>
<span class="sd">            buy_price_batch (torch.Tensor): A batch of buy price. The shape is ``(batch_size, sequence_length)``.</span>
<span class="sd">            sell_price_batch (torch.Tensor): A batch of sell price. The shape is ``(batch_size, sequence_length)``.</span>
<span class="sd">            buy_cost_pct (float): The cost ratio when the agent chooses to buy.</span>
<span class="sd">            sell_cost_pct (float): The cost ratio when the agent chooses to sell.</span>

<span class="sd">        Returns:</span>
<span class="sd">            node_reward (torch.Tensor): The reward when arriving at each node. The shape is ``(sequence_length, 3, batch_size)``.</span>
<span class="sd">            edge_reward (torch.Tensor): The reward when passing each edge. The shape is ``(sequence_length, 3, batch_size)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sequence_length</span> <span class="o">=</span> <span class="n">buy_price_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">buy_price_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># price</span>
        <span class="n">initial_price</span> <span class="o">=</span> <span class="p">((</span><span class="n">buy_price_batch</span> <span class="o">+</span> <span class="n">sell_price_batch</span><span class="p">)</span> <span class="o">/</span>
                         <span class="mi">2</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">((</span><span class="n">sequence_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">buy_price_batch</span> <span class="o">=</span> <span class="n">buy_price_batch</span><span class="o">/</span><span class="n">initial_price</span>
        <span class="n">sell_price_batch</span> <span class="o">=</span> <span class="n">sell_price_batch</span><span class="o">/</span><span class="n">initial_price</span>
        <span class="n">mid_price</span> <span class="o">=</span> <span class="p">(</span><span class="n">buy_price_batch</span> <span class="o">+</span> <span class="n">sell_price_batch</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">buy_price</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">+</span> <span class="p">(</span><span class="n">buy_price_batch</span> <span class="o">-</span> <span class="n">mid_price</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty</span>
        <span class="n">sell_price</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">+</span> <span class="p">(</span><span class="n">sell_price_batch</span> <span class="o">-</span> <span class="n">mid_price</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty</span>
        <span class="c1"># node reward</span>
        <span class="n">node_reward</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">node_reward</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">buy_price</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">node_reward</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sell_price</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">node_reward</span> <span class="o">=</span> <span class="n">node_reward</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">node_reward</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">node_reward</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># edge reward</span>
        <span class="n">edge_reward</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">edge_reward</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">buy_price</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">buy_cost_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty</span><span class="p">)</span>
        <span class="n">edge_reward</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">buy_price</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">buy_cost_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty</span><span class="p">)</span>
        <span class="n">edge_reward</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">buy_price</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">buy_cost_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty</span><span class="p">)</span>
        <span class="n">edge_reward</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sell_price</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">sell_cost_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty</span><span class="p">)</span>
        <span class="n">edge_reward</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sell_price</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">sell_cost_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty</span><span class="p">)</span>
        <span class="n">edge_reward</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sell_price</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">sell_cost_pct</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty</span><span class="p">)</span>
        <span class="n">edge_reward</span> <span class="o">=</span> <span class="n">edge_reward</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">edge_reward</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">edge_reward</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node_reward</span><span class="p">,</span> <span class="n">edge_reward</span></div>

<div class="viewcode-block" id="TrainerOASS.train_epoch"><a class="viewcode-back" href="../../api/oass.AlgorithmicTrading.html#oass.AlgorithmicTrading.TrainerOASS.train_epoch">[docs]</a>    <span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Train the model for an epoch.</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            model (torch.nn.Module): The neural network model.</span>
<span class="sd">            data_loader (torch.utils.data.DataLoader): The data loader which contains the ``train`` dataset.</span>
<span class="sd">            optimizer (torch.optim.Adam): The optimizer provided by PyTorch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            sum_loss, sum_reward (float, float): The average loss and reward of each sequence in the data loader.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">sum_loss</span><span class="p">,</span> <span class="n">sum_reward</span><span class="p">,</span> <span class="n">data_amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">batch_id</span><span class="p">,</span> <span class="n">data_batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
            <span class="c1"># get data from data_loader</span>
            <span class="n">observation_batch</span><span class="p">,</span> <span class="n">buy_price_batch</span><span class="p">,</span> <span class="n">sell_price_batch</span> <span class="o">=</span> <span class="n">data_batch</span>
            <span class="n">observation_batch</span> <span class="o">=</span> <span class="n">observation_batch</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="c1"># action probability</span>
            <span class="n">action_prob</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">observation_batch</span><span class="p">)</span>
            <span class="n">action_prob</span> <span class="o">=</span> <span class="n">action_prob</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span>
                <span class="n">action_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">action_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span>
            <span class="p">))</span>
            <span class="n">action_prob</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">action_prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># reward</span>
            <span class="n">node_reward</span><span class="p">,</span> <span class="n">edge_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_reward</span><span class="p">(</span>
                <span class="n">buy_price_batch</span><span class="p">,</span> <span class="n">sell_price_batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_cost_pct</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell_cost_pct</span>
            <span class="p">)</span>
            <span class="c1"># gradient</span>
            <span class="n">E</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_calculator</span><span class="o">.</span><span class="n">calculate_gradient</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                <span class="n">action_prob</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                <span class="n">node_reward</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                <span class="n">edge_reward</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="c1"># loss</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">action_prob</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
            <span class="c1"># optimize</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="c1"># log</span>
            <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">sum_reward</span> <span class="o">+=</span> <span class="n">E</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">node2index</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">data_amount</span> <span class="o">+=</span> <span class="n">observation_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sum_loss</span> <span class="o">/=</span> <span class="n">data_amount</span>
        <span class="n">sum_reward</span> <span class="o">/=</span> <span class="n">data_amount</span>
        <span class="k">return</span> <span class="n">sum_loss</span><span class="p">,</span> <span class="n">sum_reward</span></div>

<div class="viewcode-block" id="TrainerOASS.test_epoch"><a class="viewcode-back" href="../../api/oass.AlgorithmicTrading.html#oass.AlgorithmicTrading.TrainerOASS.test_epoch">[docs]</a>    <span class="k">def</span> <span class="nf">test_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test the model for an epoch.</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            model (torch.nn.Module): The neural network model.</span>
<span class="sd">            data_loader (torch.utils.data.DataLoader): The data loader which contains the ``dev`` (or ``test``) dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            sum_loss, sum_reward (float, float): The average loss and reward of each sequence in the data loader.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">sum_loss</span><span class="p">,</span> <span class="n">sum_reward</span><span class="p">,</span> <span class="n">data_amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">batch_id</span><span class="p">,</span> <span class="n">data_batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="c1"># get data from data_loader</span>
                <span class="n">observation_batch</span><span class="p">,</span> <span class="n">buy_price_batch</span><span class="p">,</span> <span class="n">sell_price_batch</span> <span class="o">=</span> <span class="n">data_batch</span>
                <span class="n">observation_batch</span> <span class="o">=</span> <span class="n">observation_batch</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="c1"># action probability</span>
                <span class="n">action_prob</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">observation_batch</span><span class="p">)</span>
                <span class="n">action_prob</span> <span class="o">=</span> <span class="n">action_prob</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span>
                    <span class="n">action_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">action_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span>
                <span class="p">))</span>
                <span class="n">action_prob</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">action_prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># reward</span>
                <span class="n">node_reward</span><span class="p">,</span> <span class="n">edge_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_reward</span><span class="p">(</span>
                    <span class="n">buy_price_batch</span><span class="p">,</span> <span class="n">sell_price_batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_cost_pct</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell_cost_pct</span>
                <span class="p">)</span>
                <span class="c1"># gradient</span>
                <span class="n">E</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_calculator</span><span class="o">.</span><span class="n">calculate_gradient</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
                    <span class="n">action_prob</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                    <span class="n">node_reward</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                    <span class="n">edge_reward</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="c1"># loss</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">D</span><span class="p">)),</span> <span class="n">D</span><span class="p">,</span> <span class="n">action_prob</span><span class="p">):</span>
                    <span class="c1"># head_mask and tail_mask</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">head_mask</span><span class="o">*</span><span class="mi">3</span> <span class="ow">or</span> <span class="n">i</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">tail_mask</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">loss</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
                <span class="c1"># log</span>
                <span class="n">sum_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">sum_reward</span> <span class="o">+=</span> <span class="n">E</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">node2index</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">data_amount</span> <span class="o">+=</span> <span class="n">observation_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sum_loss</span> <span class="o">/=</span> <span class="n">data_amount</span>
        <span class="n">sum_reward</span> <span class="o">/=</span> <span class="n">data_amount</span>
        <span class="k">return</span> <span class="n">sum_loss</span><span class="p">,</span> <span class="n">sum_reward</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Artiprocher.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>